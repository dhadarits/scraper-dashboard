<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scraper Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .log-box { white-space: pre-wrap; word-wrap: break-word; }
        @import url('https://rsms.me/inter/inter.css');
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Scraper Control Panel</h1>
            <p class="text-gray-600">Monitor and control your Ritchie Bros. scraper.</p>
        </header>
        <section id="config-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="github-user" class="block text-sm font-medium text-gray-700">GitHub Username</label>
                    <input type="text" id="github-user" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., your-username">
                </div>
                <div>
                    <label for="github-repo" class="block text-sm font-medium text-gray-700">GitHub Repository</label>
                    <input type="text" id="github-repo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., ritchie-bros-scraper">
                </div>
                <div class="md:col-span-2">
                    <label for="github-token" class="block text-sm font-medium text-gray-700">GitHub Personal Access Token</label>
                    <input type="password" id="github-token" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="ghp_...">
                    <p class="mt-2 text-xs text-gray-500">
                        Create a <a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" class="text-indigo-600 hover:underline">Fine-Grained Token</a> with "Contents" Read & Write access for this repository.
                    </p>
                </div>
            </div>
            <button id="fetch-data-btn" class="mt-4 w-full md:w-auto inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                Load Data
            </button>
        </section>
        <main id="dashboard-content" class="hidden">
            <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">Controls</h2>
                <div class="flex items-center space-x-4">
                    <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-400"></div>
                    <span id="status-text" class="font-medium">Unknown</span>
                    <button id="pause-btn" class="rounded-md bg-yellow-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-yellow-600">Pause</button>
                    <button id="resume-btn" class="rounded-md bg-green-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-600">Resume</button>
                </div>
            </section>
            <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-2">Progress</h2>
                <p id="progress-text" class="text-sm text-gray-600 mb-2">Loading summary...</p>
                <div class="w-full bg-gray-200 rounded-full h-4"><div id="progress-bar" class="bg-blue-600 h-4 rounded-full" style="width: 0%"></div></div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 text-center">
                    <div><p class="text-2xl font-bold" id="total-jobs">0</p><p class="text-sm text-gray-500">Total</p></div>
                    <div><p class="text-2xl font-bold text-green-600" id="completed-jobs">0</p><p class="text-sm text-gray-500">Completed</p></div>
                    <div><p class="text-2xl font-bold text-yellow-600" id="pending-jobs">0</p><p class="text-sm text-gray-500">Pending</p></div>
                    <div><p class="text-2xl font-bold text-red-600" id="failed-jobs">0</p><p class="text-sm text-gray-500">Failed</p></div>
                </div>
            </section>
            <section class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">Latest Log Output</h2>
                <div class="bg-gray-900 text-white text-xs font-mono p-4 rounded-md max-h-96 overflow-y-auto"><code id="log-output" class="log-box">Loading logs...</code></div>
            </section>
        </main>
        <div id="error-message" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
    </div>
<script>
    const githubUserInput = document.getElementById('github-user'), githubRepoInput = document.getElementById('github-repo'), githubTokenInput = document.getElementById('github-token'), fetchDataBtn = document.getElementById('fetch-data-btn'), dashboardContent = document.getElementById('dashboard-content'), configSection = document.getElementById('config-section'), errorMessageDiv = document.getElementById('error-message');
    let GITHUB_USER, GITHUB_REPO, GITHUB_TOKEN, configSHA = null;
    async function githubApiRequest(endpoint, method = 'GET', body = null) {
        const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/${endpoint}`, headers = {'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json'}, options = {method, headers};
        if (body) options.body = JSON.stringify(body);
        const response = await fetch(url, options);
        if (!response.ok) { const error = await response.json(); throw new Error(`GitHub API Error: ${error.message || response.statusText}`); }
        return response.json();
    }
    async function getRepoFile(path) {
        try { const data = await githubApiRequest(`contents/${path}`); return { content: atob(data.content), sha: data.sha }; } catch (error) { return { content: null, sha: null }; }
    }
    async function updateRepoFile(path, content, sha, message) { return await githubApiRequest(`contents/${path}`, 'PUT', { message, content: btoa(content), sha }); }
    async function fetchDashboardData() {
        showError(null); fetchDataBtn.textContent = 'Loading...'; fetchDataBtn.disabled = true;
        try {
            const [summaryData, logData, configData] = await Promise.all([getRepoFile('summary.json'), getRepoFile('scraper.log'), getRepoFile('config.json')]);
            updateProgress(summaryData.content ? JSON.parse(summaryData.content) : {});
            document.getElementById('log-output').textContent = logData.content || 'Log file not found.';
            if (configData.content) { configSHA = configData.sha; updateControls(JSON.parse(configData.content)); } else { configSHA = null; updateControls({ status: 'running' }); }
            dashboardContent.classList.remove('hidden');
        } catch (error) { showError(error.message); dashboardContent.classList.add('hidden'); } finally { fetchDataBtn.textContent = 'Load Data'; fetchDataBtn.disabled = false; }
    }
    function updateProgress(data) {
        const total = data.total || 0, completed = data.completed || 0, pending = data.pending || 0, failed = data.failed || 0, percent = total > 0 ? ((completed + failed) / total * 100).toFixed(2) : 0;
        document.getElementById('total-jobs').textContent = total; document.getElementById('completed-jobs').textContent = completed; document.getElementById('pending-jobs').textContent = pending; document.getElementById('failed-jobs').textContent = failed;
        document.getElementById('progress-bar').style.width = `${percent}%`; document.getElementById('progress-text').textContent = `${completed + failed} of ${total} pages processed (${percent}%)`;
    }
    function updateControls(data) {
        const statusText = document.getElementById('status-text'), statusIndicator = document.getElementById('status-indicator');
        if (data.status === 'paused') { statusText.textContent = 'Paused'; statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-500'; } else { statusText.textContent = 'Running'; statusIndicator.className = 'w-4 h-4 rounded-full bg-green-500'; }
    }
    async function setScraperStatus(status) {
        const message = `Dashboard: Set status to ${status}`, newContent = JSON.stringify({ status }, null, 2);
        try { const fileData = await getRepoFile('config.json'); const result = await updateRepoFile('config.json', newContent, fileData.sha, message); configSHA = result.content.sha; updateControls({ status }); alert(`Scraper status set to ${status}!`); } catch (error) { showError(`Failed to update config: ${error.message}`); }
    }
    function showError(message) { if (message) { errorMessageDiv.textContent = message; errorMessageDiv.classList.remove('hidden'); } else { errorMessageDiv.classList.add('hidden'); } }
    fetchDataBtn.addEventListener('click', () => { GITHUB_USER = githubUserInput.value.trim(); GITHUB_REPO = githubRepoInput.value.trim(); GITHUB_TOKEN = githubTokenInput.value.trim(); if (!GITHUB_USER || !GITHUB_REPO || !GITHUB_TOKEN) return showError("Please fill in all configuration fields."); fetchDashboardData(); });
    document.getElementById('pause-btn').addEventListener('click', () => setScraperStatus('paused'));
    document.getElementById('resume-btn').addEventListener('click', () => setScraperStatus('running'));
</script>
</body>
</html>
